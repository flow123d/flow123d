name: Flow123d debug CI

on:
  push:
    branches:
      - "**"
  # !! workflow_dispatch configuration must be in the default branch, i.e. 'master'
  workflow_dispatch:
    inputs:
      environment:
        description: Build environment [gnu, intel].
        type: choice
        options:
          - gnu
          - intel
        required: false
        default: gnu
env:
  artifact-dir: build-dir
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-ci-debug
  cancel-in-progress: true
jobs:
  create-env:
    name: Create environments
    runs-on: ubuntu-latest
    outputs:
      build-dir: ${{ steps.vars.outputs.build-dir }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set variables
        id: vars
        run: |
          build_dir=build-$(git rev-parse --abbrev-ref HEAD)
          echo "build-dir=${build_dir}" >> $GITHUB_OUTPUT

      - name: Check vars
        run: |
          echo build-dir="${{ steps.vars.outputs.build-dir }}"

  build:
    name: Flow123d debug main build
    runs-on: ubuntu-latest
    needs:
      - create-env
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build flow123d, verify, tarball.
        run: config/build/auto_build.sh dbg gnu ci $(cat version)

      - name: Benchmark meshes
        run: config/build/create_unit_test_meshes.sh ${{ needs.create-env.outputs.build-dir }}/benchmark_meshes

      - name: Tarball build dir
        run: config/build/tar_build_dir.sh ${{ needs.create-env.outputs.build-dir }}

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.artifact-dir }}
          path: build_dir.tar

  integration-tests:
    name: Integration Test ${{ matrix.test_dir }}
    runs-on: ubuntu-latest
    needs:
      - build
    strategy:
      fail-fast: false
      matrix:
        test_dir:
        - 01_cmd_line
        - 02_generic_input
        - 03_generic_output
        - 04_generic_mesh
        - 05_tutorial
        - 06_errors
        - 10_darcy
        - 11_darcy_bc
        - 12_darcy_frac
        - 13_darcy_time
        - 14_darcy_richards
        - 20_solute_fv
        - 21_solute_fv_frac
        - 22_solute_fv_time
        - 24_solute_dg
        - 25_solute_dg_bc
        - 26_solute_dg_frac
        - 27_solute_dg_time
        - 30_sorption
        - 31_dual_por
        - 32_decay
        - 33_reaction
        - 34_sorption_dg
        - 40_heat
        - 50_mechanics
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build dir
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.artifact-dir }}

      - name: Run integration tests
        run: config/build/run_with_build_dir.sh dbg_gnu tests/runtest tests/${{matrix.test_dir}}  --keep-going --batch

  unit-tests:
    name: Unit Test ${{matrix.test_dir}}
    runs-on: ubuntu-latest
    needs:
      - build
    permissions:
      contents: read
      actions: read
      checks: write
    strategy:
      fail-fast: false
      matrix:
        test_dir:
        - coupling
        - fem
        - fields
        - flow
        - input
        - intersection
        - la
        - mesh
        - output
        - scripts
        - system
        - test_scripts
        - tools
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build dir
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.artifact-dir }}

      - name: Run UNIT tests
        id: unit-test
        run: config/build/run_with_build_dir.sh dbg_gnu make -C build_tree/unit_tests/${{matrix.test_dir}} -k all-test

      - name: Unit test reporter
        if: ${{ always() && steps.unit-test.outcome == 'failure' }}
        uses: dorny/test-reporter@v1
        id: test-reporter
        with:
          name: Reports of ${{ matrix.test_dir }}
          path: build_tree/unit_tests/${{ matrix.test_dir }}/**.xml
          reporter: java-junit
          fail-on-error: true
          fail-on-empty: true
          list-suites: failed
          list-tests: failed
          only-summary: true

  build-doc:
    name: Test build doc
    runs-on: ubuntu-latest
    needs:
      - build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build dir
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.artifact-dir }}

      - name: Build documentation
        run: config/build/run_with_build_dir.sh  dbg_gnu make ref-doc
